#!/bin/bash

if [ -z "$1" ]; then
    echo "Error: version_name is not specified."
    echo "Usage: $0 <version_name>"
    exit 1
fi

version_name=$1

version_code=$(grep "versionCode" app/build.gradle | awk '{print $2}' | tr -d '\n')
if [ -z "$version_code" ]; then
    echo "Error: Failed to extract versionCode from app/build.gradle."
    exit 1
fi

version_code=$((version_code + 1))

sed -i "s/versionCode [0-9]\+/versionCode $version_code/g" app/build.gradle
if [ $? -ne 0 ]; then
    echo "Error: Failed to update versionCode in app/build.gradle."
    exit 1
fi

sed -i "s/versionName \"[^\"]*\"/versionName \"$version_name\"/g" app/build.gradle
if [ $? -ne 0 ]; then
    echo "Error: Failed to update versionName in app/build.gradle."
    exit 1
fi

chmod +x ./gradlew
if [ $? -ne 0 ]; then
    echo "Error: Failed to change permissions for gradlew."
    exit 1
fi

./gradlew --no-daemon assembleRelease
if [ $? -ne 0 ]; then
    echo "Error: Project build failed."
    exit 1
fi

echo "Build completed successfully!"
